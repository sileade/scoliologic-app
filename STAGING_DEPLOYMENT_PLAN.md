# План развёртывания Scoliologic App в Staging-среде

**Дата:** 26 января 2026  
**Документ подготовил:** Manus AI

---

## 1. Обзор и цели

Этот документ описывает пошаговый план развёртывания приложения Scoliologic в **staging-среде**. Staging-среда является точной копией production-инфраструктуры и предназначена для финального тестирования перед выпуском релиза.

**Цели:**
- Развернуть полный стек приложения с помощью Docker Compose.
- Настроить автоматическое получение SSL-сертификатов через Traefik.
- Обеспечить безопасное хранение конфигурации и секретов.
- Активировать GitOps-агента для автоматического развёртывания обновлений из `main` ветки.

## 2. Команда и роли

| Роль | Ответственный | Задачи |
|:---|:---|:---|
| **DevOps Инженер** | TBD | Подготовка сервера, настройка DNS, Docker, CI/CD, мониторинг. |
| **Разработчик** | TBD | Подготовка `.env` файла, тестирование функционала. |
| **QA Инженер** | TBD | Проведение smoke-тестов, валидация развёртывания. |

---

## 3. План развёртывания

План разбит на 5 основных этапов, которые должны выполняться последовательно.

### Этап 1: Подготовка инфраструктуры (Отв: DevOps Инженер)

1.  **Выделить сервер:**
    -   **Тип:** Виртуальная или физическая машина.
    -   **ОС:** Ubuntu 22.04 LTS или Debian 12.
    -   **Ресурсы (минимум):** 4 vCPU, 8 GB RAM, 100 GB SSD.

2.  **Установить ПО:**
    -   Установить `Docker` и `Docker Compose` последней версии.
    -   Установить `git`.

3.  **Настроить сеть и DNS:**
    -   Открыть порты `80/tcp` и `443/tcp` в firewall.
    -   Создать A-записи в DNS для следующих доменов, указывающие на IP сервера:
        -   `app.staging.scoliologic.ru`
        -   `traefik.staging.scoliologic.ru`
        -   `grafana.staging.scoliologic.ru` (опционально)

### Этап 2: Конфигурация приложения (Отв: Разработчик, DevOps Инженер)

1.  **Клонировать репозиторий:**
    ```bash
    git clone https://github.com/sileade/scoliologic-app.git /opt/scoliologic-app
    cd /opt/scoliologic-app
    ```

2.  **Создать файл окружения:**
    -   Скопировать `.env.example` в `.env`.
    -   **Ответственный: Разработчик** - заполнить все переменные.

3.  **Заполнить `.env` файл:**

| Переменная | Значение | Ответственный |
|:---|:---|:---|
| `POSTGRES_PASSWORD` | Сгенерировать надёжный пароль | DevOps |
| `JWT_SECRET` | Сгенерировать надёжный ключ (32+ символа) | DevOps |
| `SESSION_SECRET` | Сгенерировать надёжный ключ (32+ символа) | DevOps |
| `ESIA_CLIENT_ID` | ID тестовой среды ЕСИА | Разработчик |
| `ESIA_CLIENT_SECRET` | Секрет тестовой среды ЕСИА | Разработчик |
| `ESIA_REDIRECT_URI` | `https://app.staging.scoliologic.ru/api/auth/esia/callback` | Разработчик |
| `MIS_API_KEY` | Ключ для тестовой среды МИС | Разработчик |
| `ACME_EMAIL` | Email для уведомлений Let's Encrypt | DevOps |
| `TRAEFIK_AUTH` | Сгенерировать `user:hash` для доступа к дашборду Traefik | DevOps |
| `GIT_TOKEN` | GitHub Personal Access Token с правами `repo` | DevOps |

### Этап 3: Первое развёртывание (Отв: DevOps Инженер)

1.  **Запустить основные сервисы:**
    -   Используется профиль `traefik` для запуска веб-стека.
    ```bash
    cd /opt/scoliologic-app
    docker-compose --profile traefik up -d
    ```

2.  **Проверить статус контейнеров:**
    -   Убедиться, что все контейнеры (`app`, `postgres`, `redis`, `ollama`, `traefik`) запущены и здоровы.
    ```bash
    docker-compose ps
    ```

3.  **Проверить логи:**
    -   Просмотреть логи на предмет ошибок, особенно у `traefik` (получение SSL) и `app`.
    ```bash
    docker-compose logs -f traefik app
    ```

### Этап 4: Валидация и Smoke-тест (Отв: QA Инженер)

1.  **Проверить доступность приложения:**
    -   Открыть в браузере `https://app.staging.scoliologic.ru`.
    -   Убедиться, что сайт открывается по HTTPS с валидным сертификатом.

2.  **Провести Smoke-тест:**
    -   Авторизация через ЕСИА.
    -   Отправка сообщения в AI-чат.
    -   Создание чата с врачом.
    -   Проверка загрузки всех основных страниц (Dashboard, Настройки, Изделия).

3.  **Проверить дашборд Traefik:**
    -   Открыть `https://traefik.staging.scoliologic.ru`.
    -   Авторизоваться с данными из `TRAEFIK_AUTH`.
    -   Убедиться, что все сервисы корректно определены.

### Этап 5: Активация GitOps (Отв: DevOps Инженер)

1.  **Запустить Pull-агента:**
    -   После успешной валидации можно активировать автоматическое развёртывание.
    ```bash
    docker-compose up -d pull-agent
    ```

2.  **Проверить работу агента:**
    -   Просмотреть логи агента, убедиться, что он успешно подключился к репозиторию.
    ```bash
    docker-compose logs -f pull-agent
    ```

3.  **Сделать тестовый коммит:**
    -   **Ответственный: Разработчик** - сделать небольшой коммит в `main` ветку (например, изменить текст на главной).
    -   **Ответственный: DevOps Инженер** - проконтролировать, что `pull-agent` обнаружил коммит, пересобрал `app` контейнер и автоматически применил изменения (в течение 5 минут).

---

## 4. План отката

В случае сбоя на любом этапе:

-   **При развёртывании:** Остановить и удалить все контейнеры (`docker-compose down -v`), проанализировать логи, исправить проблему и повторить развёртывание.
-   **После обновления через GitOps:** `pull-agent` настроен на автоматический откат (`ROLLBACK_ON_FAILURE=true`). Если новый контейнер не проходит health-check, агент вернёт предыдущую рабочую версию.

---

*Этот план обеспечивает надёжное и автоматизированное развёртывание. Удачи!*

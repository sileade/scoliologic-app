/**
 * tRPC —Ä–æ—É—Ç–µ—Ä –¥–ª—è AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ (Ollama)
 */

import { z } from "zod";
import { router, protectedProcedure, publicProcedure } from "../_core/trpc";
import {
  checkOllamaHealth,
  listModels,
  chat,
  getMedicalResponse,
  OllamaMessage,
} from "./ollama";

export const aiTrpcRouter = router({
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Ollama
  health: publicProcedure.query(async () => {
    return checkOllamaHealth();
  }),

  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π
  models: publicProcedure.query(async () => {
    return listModels();
  }),

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è AI
  chat: protectedProcedure
    .input(z.object({
      messages: z.array(z.object({
        role: z.enum(["system", "user", "assistant"]),
        content: z.string(),
      })),
      model: z.string().optional(),
      temperature: z.number().min(0).max(1).optional(),
    }))
    .mutation(async ({ input }) => {
      const result = await chat(input.messages as OllamaMessage[], {
        model: input.model,
        temperature: input.temperature,
      });
      
      return result;
    }),

  // –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –ø–∞—Ü–∏–µ–Ω—Ç–∞
  medicalConsult: protectedProcedure
    .input(z.object({
      question: z.string(),
      patientContext: z.object({
        name: z.string().optional(),
        diagnosis: z.string().optional(),
        currentTreatment: z.string().optional(),
        deviceType: z.string().optional(),
        wearSchedule: z.string().optional(),
      }).optional(),
    }))
    .mutation(async ({ input }) => {
      const result = await getMedicalResponse(
        input.question,
        input.patientContext
      );
      
      return result;
    }),

  // –ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ —á–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã
  quickAnswer: protectedProcedure
    .input(z.object({
      topic: z.enum([
        "corset_wearing",
        "exercises",
        "pain_management",
        "hygiene",
        "school_sports",
        "travel",
        "adjustment",
        "emergency",
      ]),
    }))
    .query(async ({ input }) => {
      const quickAnswers: Record<string, string> = {
        corset_wearing: `**–†–µ–∂–∏–º –Ω–æ—à–µ–Ω–∏—è –∫–æ—Ä—Å–µ—Ç–∞ –®–µ–Ω–æ**

–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–µ–∂–∏–º –Ω–æ—à–µ–Ω–∏—è:
- **–ù–∞—á–∞–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥ (1-2 –Ω–µ–¥–µ–ª–∏)**: –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–æ—à–µ–Ω–∏—è
- **–û—Å–Ω–æ–≤–Ω–æ–π –ø–µ—Ä–∏–æ–¥**: 20-23 —á–∞—Å–∞ –≤ —Å—É—Ç–∫–∏
- **–°–Ω—è—Ç–∏–µ**: —Ç–æ–ª—å–∫–æ –¥–ª—è –≥–∏–≥–∏–µ–Ω—ã, –õ–§–ö –∏ –≤–æ–¥–Ω—ã—Ö –ø—Ä–æ—Ü–µ–¥—É—Ä

‚ö†Ô∏è –¢–æ—á–Ω—ã–π —Ä–µ–∂–∏–º –Ω–∞–∑–Ω–∞—á–∞–µ—Ç –≤–∞—à –ª–µ—á–∞—â–∏–π –≤—Ä–∞—á!`,

        exercises: `**–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –ø—Ä–∏ —Å–∫–æ–ª–∏–æ–∑–µ (–º–µ—Ç–æ–¥–∏–∫–∞ –®—Ä–æ—Ç)**

–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:
- –í—ã–ø–æ–ª–Ω—è–π—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ
- –ù–∞—á–∏–Ω–∞–π—Ç–µ —Å 15-20 –º–∏–Ω—É—Ç, –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞—è
- –°–ª–µ–¥–∏—Ç–µ –∑–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –¥—ã—Ö–∞–Ω–∏–µ–º
- –ù–µ –∑–∞–Ω–∏–º–∞–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ –±–æ–ª—å

üìã –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –Ω–∞–∑–Ω–∞—á–∞–µ—Ç –≤—Ä–∞—á –õ–§–ö`,

        pain_management: `**–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç–æ–º**

–ü—Ä–∏ –Ω–æ—à–µ–Ω–∏–∏ –∫–æ—Ä—Å–µ—Ç–∞ –≤–æ–∑–º–æ–∂–µ–Ω –¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç:
- **–ü–µ—Ä–≤—ã–µ –¥–Ω–∏**: –ª—ë–≥–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
- **–ü–æ–∫—Ä–∞—Å–Ω–µ–Ω–∏—è –∫–æ–∂–∏**: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ö–ª–æ–ø–∫–æ–≤—É—é –º–∞–π–∫—É
- **–°–∏–ª—å–Ω–∞—è –±–æ–ª—å**: –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –≤—Ä–∞—á—É!

üè• –ü—Ä–∏ –ª—é–±—ã—Ö —Å–æ–º–Ω–µ–Ω–∏—è—Ö ‚Äî –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å –≤—Ä–∞—á–æ–º`,

        hygiene: `**–ì–∏–≥–∏–µ–Ω–∞ –ø—Ä–∏ –Ω–æ—à–µ–Ω–∏–∏ –∫–æ—Ä—Å–µ—Ç–∞**

–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
- –ù–æ—Å–∏—Ç–µ —Ö–ª–æ–ø–∫–æ–≤—É—é –±–µ—Å—à–æ–≤–Ω—É—é –º–∞–π–∫—É –ø–æ–¥ –∫–æ—Ä—Å–µ—Ç
- –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –ø—Ä–æ—Ç–∏—Ä–∞–π—Ç–µ –∫–æ—Ä—Å–µ—Ç –≤–ª–∞–∂–Ω–æ–π —Ç–∫–∞–Ω—å—é
- –ü—Ä–∏–Ω–∏–º–∞–π—Ç–µ –¥—É—à –≤–æ –≤—Ä–µ–º—è –ø–µ—Ä–µ—Ä—ã–≤–æ–≤
- –°–ª–µ–¥–∏—Ç–µ –∑–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∫–æ–∂–∏

üß¥ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –¥–ª—è –∫–æ–∂–∏`,

        school_sports: `**–®–∫–æ–ª–∞ –∏ —Å–ø–æ—Ä—Ç**

–ü—Ä–∏ —Å–∫–æ–ª–∏–æ–∑–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:
- ‚úÖ –ü–ª–∞–≤–∞–Ω–∏–µ (–æ—Å–æ–±–µ–Ω–Ω–æ –Ω–∞ —Å–ø–∏–Ω–µ)
- ‚úÖ –•–æ–¥—å–±–∞, –ª—ë–≥–∫–∏–π –±–µ–≥
- ‚úÖ –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –õ–§–ö
- ‚ùå –ü—Ä—ã–∂–∫–∏, —Ç—è–∂—ë–ª–∞—è –∞—Ç–ª–µ—Ç–∏–∫–∞
- ‚ùå –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –≤–∏–¥—ã —Å–ø–æ—Ä—Ç–∞

üìö –í —à–∫–æ–ª–µ: —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ø–∞—Ä—Ç–∞, –ø–µ—Ä–µ—Ä—ã–≤—ã –Ω–∞ —Ä–∞–∑–º–∏–Ω–∫—É`,

        travel: `**–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è —Å –∫–æ—Ä—Å–µ—Ç–æ–º**

–°–æ–≤–µ—Ç—ã:
- –í–æ–∑—å–º–∏—Ç–µ —Å–ø—Ä–∞–≤–∫—É –æ—Ç –≤—Ä–∞—á–∞ (–Ω–∞ —Ä—É—Å—Å–∫–æ–º –∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º)
- –í —Å–∞–º–æ–ª—ë—Ç–µ: —Å–Ω–∏–º–∞–π—Ç–µ –∫–æ—Ä—Å–µ—Ç –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–ª—ë—Ç–∞—Ö
- –î–µ–ª–∞–π—Ç–µ —Ä–∞–∑–º–∏–Ω–∫—É –∫–∞–∂–¥—ã–µ 2-3 —á–∞—Å–∞
- –í–æ–∑—å–º–∏—Ç–µ –∑–∞–ø–∞—Å–Ω—É—é –º–∞–π–∫—É

‚úàÔ∏è –ö–æ—Ä—Å–µ—Ç –º–æ–∂–Ω–æ –ø—Ä–æ–≤–æ–∑–∏—Ç—å –≤ —Ä—É—á–Ω–æ–π –∫–ª–∞–¥–∏`,

        adjustment: `**–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –∫–æ—Ä—Å–µ—Ç–∞**

–ö–æ–≥–¥–∞ –Ω—É–∂–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞:
- –ö–∞–∂–¥—ã–µ 3-6 –º–µ—Å—è—Ü–µ–≤ (–ø–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—é –≤—Ä–∞—á–∞)
- –ü—Ä–∏ —Ä–æ—Å—Ç–µ —Ä–µ–±—ë–Ω–∫–∞
- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É–≥–ª–∞ –∏—Å–∫—Ä–∏–≤–ª–µ–Ω–∏—è
- –ü—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç–∞

üìû –ó–∞–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –ø—Ä–∏—ë–º —á–µ—Ä–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ`,

        emergency: `**–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏**

–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –≤—Ä–∞—á—É –ø—Ä–∏:
- üî¥ –°–∏–ª—å–Ω–æ–π –±–æ–ª–∏, –Ω–µ –ø—Ä–æ—Ö–æ–¥—è—â–µ–π –ø–æ—Å–ª–µ —Å–Ω—è—Ç–∏—è –∫–æ—Ä—Å–µ—Ç–∞
- üî¥ –û–Ω–µ–º–µ–Ω–∏–∏ –∫–æ–Ω–µ—á–Ω–æ—Å—Ç–µ–π
- üî¥ –ó–∞—Ç—Ä—É–¥–Ω–µ–Ω–∏–∏ –¥—ã—Ö–∞–Ω–∏—è
- üî¥ –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–∏ –∫–æ—Ä—Å–µ—Ç–∞

üìû –¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–Ω–∏–∫–∏: +7 (495) XXX-XX-XX`,
      };

      return {
        success: true,
        topic: input.topic,
        answer: quickAnswers[input.topic] || "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –¥–∞–Ω–Ω–æ–π —Ç–µ–º–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.",
      };
    }),
});

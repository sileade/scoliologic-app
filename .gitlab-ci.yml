# GitLab CI/CD Pipeline for Ortho Patient App
# Автоматическое тестирование, сборка и деплой при коммите в main

stages:
  - test
  - build
  - deploy

variables:
  NODE_VERSION: "18"
  DOCKER_TLS_CERTDIR: "/certs"
  # Путь к приложению на сервере
  DEPLOY_PATH: "/opt/ortho-innovations/frontend/patient-app"
  # Docker Compose файл
  COMPOSE_FILE: "docker-compose.dev.yml"

# Кэширование node_modules между jobs
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - .pnpm-store/

# ============================================
# STAGE: TEST
# ============================================

# Проверка типов TypeScript
typecheck:
  stage: test
  image: node:${NODE_VERSION}-alpine
  before_script:
    - npm install -g pnpm
    - pnpm config set store-dir .pnpm-store
    - pnpm install --frozen-lockfile
  script:
    - pnpm check
  only:
    - main
    - merge_requests
  tags:
    - docker

# Запуск unit тестов
unit-tests:
  stage: test
  image: node:${NODE_VERSION}-alpine
  before_script:
    - npm install -g pnpm
    - pnpm config set store-dir .pnpm-store
    - pnpm install --frozen-lockfile
  script:
    - pnpm test
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    reports:
      junit: coverage/junit.xml
    paths:
      - coverage/
    expire_in: 1 week
  only:
    - main
    - merge_requests
  tags:
    - docker

# Линтинг кода
lint:
  stage: test
  image: node:${NODE_VERSION}-alpine
  before_script:
    - npm install -g pnpm
    - pnpm config set store-dir .pnpm-store
    - pnpm install --frozen-lockfile
  script:
    - pnpm lint || true  # Не блокируем pipeline при ошибках линтинга
  allow_failure: true
  only:
    - main
    - merge_requests
  tags:
    - docker

# ============================================
# STAGE: BUILD
# ============================================

# Сборка Docker образа
build-docker:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker info
  script:
    - docker build -t ortho-patient-app:${CI_COMMIT_SHA} .
    - docker build -t ortho-patient-app:latest .
    # Опционально: push в registry
    # - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    # - docker tag ortho-patient-app:latest $CI_REGISTRY_IMAGE:latest
    # - docker push $CI_REGISTRY_IMAGE:latest
  only:
    - main
  tags:
    - docker

# ============================================
# STAGE: DEPLOY
# ============================================

# Деплой на production сервер
deploy-production:
  stage: deploy
  image: alpine:latest
  before_script:
    # Установка SSH клиента
    - apk add --no-cache openssh-client bash
    # Настройка SSH ключа
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    # Добавление сервера в known_hosts
    - ssh-keyscan -H $DEPLOY_SERVER >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - |
      ssh $DEPLOY_USER@$DEPLOY_SERVER << 'ENDSSH'
        set -e
        echo "=== Starting deployment via GitLab CI/CD ==="
        
        # Метод 1: Использование скрипта деплоя (рекомендуется)
        if [ -f "/opt/ortho-innovations/frontend/patient-app/scripts/deploy.sh" ]; then
            echo "Using deploy.sh script..."
            cd /opt/ortho-innovations/frontend/patient-app
            bash scripts/deploy.sh --backup
        else
            # Метод 2: Прямой деплой (фолбэк)
            echo "Deploy script not found, using direct method..."
            
            # Переход в директорию проекта
            cd /opt/ortho-innovations
            
            # Получение последних изменений
            echo "=== Pulling latest changes ==="
            git fetch origin main
            git reset --hard origin/main
            
            # Переход в директорию приложения
            cd frontend/patient-app
            
            # Остановка текущих контейнеров
            echo "=== Stopping current containers ==="
            docker compose -f docker-compose.dev.yml down || true
            
            # Очистка старых образов
            echo "=== Cleaning old images ==="
            docker image prune -f || true
            
            # Сборка и запуск новых контейнеров
            echo "=== Building and starting new containers ==="
            docker compose -f docker-compose.dev.yml up -d --build
        fi
        
        # Проверка статуса
        echo "=== Checking container status ==="
        sleep 15
        docker compose -f docker-compose.dev.yml ps
        
        # Проверка health check
        echo "=== Health check ==="
        curl -f http://localhost:3000/api/health || echo "Health check endpoint not available"
        
        echo "=== Deployment completed successfully ==="
      ENDSSH
  environment:
    name: production
    url: https://patient.orthoinnovations.ae
  only:
    - main
  when: on_success
  tags:
    - docker

# ============================================
# MANUAL JOBS
# ============================================

# Ручной откат к предыдущей версии
rollback:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client bash
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_SERVER >> ~/.ssh/known_hosts
  script:
    - |
      ssh $DEPLOY_USER@$DEPLOY_SERVER << 'ENDSSH'
        set -e
        cd /opt/ortho-innovations
        
        # Откат к предыдущему коммиту
        git reset --hard HEAD~1
        
        cd frontend/patient-app
        docker compose -f docker-compose.dev.yml down
        docker compose -f docker-compose.dev.yml up -d --build
        
        echo "=== Rollback completed ==="
      ENDSSH
  environment:
    name: production
  when: manual
  only:
    - main
  tags:
    - docker

# Перезапуск контейнеров без пересборки
restart-containers:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client bash
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_SERVER >> ~/.ssh/known_hosts
  script:
    - |
      ssh $DEPLOY_USER@$DEPLOY_SERVER << 'ENDSSH'
        cd /opt/ortho-innovations/frontend/patient-app
        docker compose -f docker-compose.dev.yml restart
        echo "=== Containers restarted ==="
      ENDSSH
  environment:
    name: production
  when: manual
  only:
    - main
  tags:
    - docker

# Просмотр логов контейнеров
view-logs:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client bash
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_SERVER >> ~/.ssh/known_hosts
  script:
    - |
      ssh $DEPLOY_USER@$DEPLOY_SERVER << 'ENDSSH'
        cd /opt/ortho-innovations/frontend/patient-app
        docker compose -f docker-compose.dev.yml logs --tail=100
      ENDSSH
  when: manual
  only:
    - main
  tags:
    - docker

# Scoliologic Patient App

**Мобильное приложение для пациентов клиники Scoliologic**

## О проекте

Клиентское приложение для пациентов клиники [Scoliologic.ru](https://scoliologic.ru), специализирующейся на лечении деформаций позвоночника (сколиоз, кифоз, лордоз). Приложение обеспечивает полный цикл взаимодействия пациента с клиникой.

### Основные возможности

| Функция | Описание | Статус |
|---------|----------|--------|
| **Госуслуги (ЕСИА)** | Авторизация через Единую систему идентификации | ✅ Готово |
| **Интеграция с МИС** | Получение данных о корсетах, ортезах, протезах | ✅ Готово |
| **Защищённый мессенджер** | E2EE чат с врачами (ECDH + AES-256-GCM) | ✅ Готово |
| **AI-ассистент** | Интегрированный в чаты помощник на базе Ollama | ✅ Готово |
| **Документы** | ИПР, справки, договоры, документы СФР | ✅ Готово |
| **План лечения** | Упражнения, график ношения корсета | ✅ Готово |

## AI-ассистент

### Новая логика работы

AI-ассистент **интегрирован во все чаты с врачами** и работает по следующему алгоритму:

```
┌─────────────────────────────────────────────────────────────────┐
│                    ЛОГИКА AI-АССИСТЕНТА                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. Пациент отправляет сообщение                               │
│     ↓                                                          │
│  2. AI мониторит все сообщения в чате                          │
│     ↓                                                          │
│  3. AI отвечает пока врач недоступен                           │
│     ↓                                                          │
│  4. Врач отвечает → AI уходит в фон на 1.5 часа               │
│     ↓                                                          │
│  5. Если врач не отвечает 1.5 часа → AI возвращается          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Особенности

| Функция | Описание |
|---------|----------|
| **Мониторинг сообщений** | AI видит все сообщения в чате с врачом |
| **Автоматический ответ** | AI отвечает пока врач не в сети |
| **Передача врачу** | Когда врач отвечает, AI уходит в фон |
| **Таймер возврата** | AI возвращается через 1.5 часа без ответа врача |
| **Ручное управление** | Пользователь может включить/выключить AI |
| **Маркировка сообщений** | Сообщения AI помечены как автоматические |

### Конфигурация AI

```env
# Ollama сервер в локальной сети
OLLAMA_BASE_URL=http://ollama.local:11434
OLLAMA_MODEL=llama3.2:3b
OLLAMA_TIMEOUT=60000
OLLAMA_MAX_TOKENS=2048
OLLAMA_TEMPERATURE=0.7

# Таймер возврата AI (мс)
AI_RETURN_TIMEOUT=5400000  # 1.5 часа
```

### Системный промпт

AI настроен как медицинский ассистент клиники:

- Отвечает на вопросы о лечении сколиоза
- Даёт информацию о корсетах Шено
- Объясняет упражнения методики Шрот
- Напоминает о приёмах и процедурах
- **Никогда не ставит диагнозы**
- Рекомендует консультацию врача при серьёзных симптомах

## Скриншоты

Скриншоты интерфейса находятся в директории `docs/screenshots/`:

- `01_dashboard.png` - Главная страница
- `02_messenger_ai.png` - Мессенджер с AI-ассистентом
- `03_documents.png` - Раздел документов
- `04_devices.png` - Мои изделия (корсеты, ортезы)
- `05_auth_gosuslugi.png` - Авторизация через Госуслуги

## Технологический стек

### Frontend
- **React 18** + TypeScript
- **Vite** — сборка и HMR
- **TailwindCSS** — стилизация
- **tRPC** — типизированный API
- **Wouter** — маршрутизация

### Backend
- **Node.js** + Express
- **tRPC** — API сервер
- **Drizzle ORM** — работа с БД
- **PostgreSQL 16** — база данных
- **Socket.IO** — real-time мессенджер

### AI
- **Ollama** — локальный LLM сервер
- **llama3.2** — основная модель
- Поддержка других моделей (mistral, codellama)

### Безопасность
- **ECDH (P-256)** — обмен ключами
- **AES-256-GCM** — шифрование сообщений
- **OAuth 2.0** — авторизация ЕСИА
- **JWT** — токены сессий

### Инфраструктура
- **Docker** + Docker Compose
- **GitLab CI/CD** — автодеплой
- **Nginx** — reverse proxy

## Быстрый старт

### Требования
- Node.js 18+
- PostgreSQL 16+
- pnpm 8+
- Ollama (для AI-ассистента)

### Установка

```bash
# Клонирование
git clone https://github.com/sileade/scoliologic-app.git
cd scoliologic-app

# Установка зависимостей
pnpm install

# Настройка окружения
cp docs/env-template.txt .env
# Отредактируйте .env файл

# Запуск PostgreSQL (Docker)
docker-compose up -d postgres

# Миграции БД
pnpm db:push

# Запуск в режиме разработки
pnpm dev
```

### Docker Compose

```bash
# Полный запуск (приложение + БД + Ollama)
docker-compose up -d

# Логи
docker-compose logs -f app
```

## Конфигурация

### Переменные окружения

```env
# База данных (PostgreSQL)
DATABASE_URL=postgresql://user:password@localhost:5432/scoliologic_db

# OAuth сервер
OAUTH_SERVER_URL=https://oauth.scoliologic.ru

# ЕСИА (Госуслуги)
ESIA_CLIENT_ID=your_client_id
ESIA_CLIENT_SECRET=your_client_secret
ESIA_REDIRECT_URI=https://app.scoliologic.ru/api/auth/esia/callback
ESIA_SCOPE=openid fullname snils

# МИС интеграция
MIS_API_URL=https://mis.scoliologic.ru/api/v1
MIS_API_KEY=your_api_key

# AI (Ollama)
OLLAMA_BASE_URL=http://ollama.local:11434
OLLAMA_MODEL=llama3.2:3b
OLLAMA_TIMEOUT=60000
OLLAMA_MAX_TOKENS=2048
```

## API Endpoints

### Аутентификация (ЕСИА)

```
GET  /api/auth/esia/login     - Начало OAuth flow
GET  /api/auth/esia/callback  - Callback после авторизации
POST /api/auth/esia/refresh   - Обновление токена
POST /api/auth/logout         - Выход
```

### МИС интеграция

```
GET  /api/trpc/mis.getPatient     - Данные пациента
GET  /api/trpc/mis.getDevices     - Изделия (корсеты, ортезы)
GET  /api/trpc/mis.getAppointments - Приёмы
GET  /api/trpc/mis.getDocuments   - Документы
POST /api/trpc/mis.sync           - Синхронизация с МИС
```

### Мессенджер

```
GET  /api/trpc/messenger.getChats       - Список чатов
GET  /api/trpc/messenger.getMessages    - Сообщения чата
POST /api/trpc/messenger.sendMessage    - Отправка сообщения
POST /api/trpc/messenger.exchangeKeys   - Обмен ключами E2EE
GET  /api/trpc/messenger.getAIStatus    - Статус AI в чате
POST /api/trpc/messenger.toggleAI       - Включить/выключить AI
```

### AI-ассистент

```
POST /api/trpc/ai.chat        - Отправка сообщения AI
GET  /api/trpc/ai.health      - Статус Ollama
POST /api/trpc/ai.analyze     - Анализ симптомов
```

## Безопасность

### Сквозное шифрование (E2EE)

Мессенджер использует протокол сквозного шифрования:

1. **Генерация ключей**: ECDH P-256 на стороне клиента
2. **Обмен ключами**: Публичные ключи передаются через сервер
3. **Шифрование**: AES-256-GCM с уникальным IV для каждого сообщения
4. **Хранение**: Сервер хранит только зашифрованные данные

### ЕСИА интеграция

Авторизация через Госуслуги обеспечивает:
- Верификацию личности пациента
- Получение СНИЛС для интеграции с СФР
- Автозаполнение данных (ФИО, дата рождения)

### AI и конфиденциальность

- AI работает на **локальном сервере Ollama** в сети клиники
- Данные пациентов **не передаются** внешним сервисам
- Сообщения AI также шифруются E2EE

## Дизайн-система

### Цветовая палитра

| Цвет | Значение | Использование |
|------|----------|---------------|
| Лаймовый | `#BFFF00` | Основные кнопки, акценты |
| Бирюзовый | `#2DBDB6` | Навигация, ссылки |
| Фиолетовый | `#9333EA` | AI-ассистент |
| Тёмный | `#1A1D23` | Фон (тёмная тема) |
| Светлый | `#F8FAFC` | Фон (светлая тема) |

### Компоненты

```css
/* Кнопки */
.btn-scolio-primary    /* Основная кнопка */
.btn-scolio-outline    /* Контурная кнопка */

/* Карточки */
.scolio-feature-card   /* Карточка с тенью */
.scolio-card-lime      /* Лаймовая карточка */
.scolio-card-teal      /* Бирюзовая карточка */

/* Поля ввода */
.input-scolio          /* Текстовое поле */
```

## Структура проекта

```
scoliologic-app/
├── client/                 # Frontend (React)
│   ├── src/
│   │   ├── components/     # UI компоненты
│   │   ├── contexts/       # React контексты
│   │   ├── lib/            # Утилиты (crypto, trpc)
│   │   └── pages/          # Страницы приложения
│   └── index.html
├── server/                 # Backend (Node.js)
│   ├── _core/              # Ядро (auth, trpc, db)
│   ├── ai/                 # AI-ассистент (Ollama)
│   │   ├── ollama.ts       # Сервис Ollama
│   │   ├── router.ts       # Express роутер
│   │   └── trpcRouter.ts   # tRPC роутер
│   ├── esia/               # Интеграция с Госуслугами
│   ├── messenger/          # Защищённый мессенджер
│   │   ├── service.ts      # Логика AI в чатах
│   │   └── router.ts       # tRPC роутер
│   └── mis/                # Интеграция с МИС
├── drizzle/                # Схема БД
├── docs/                   # Документация
│   ├── screenshots/        # Скриншоты
│   └── env-template.txt    # Шаблон .env
├── docker-compose.yml
├── Dockerfile
└── package.json
```

## Тестирование

```bash
# Запуск всех тестов
pnpm test

# Проверка типов
pnpm check

# Линтинг
pnpm lint
```

### Результаты тестов

```
Test Files  4 passed (4)
Tests       37 passed (37)
```

## Деплой

### GitLab CI/CD

Автоматический деплой настроен в `.gitlab-ci.yml`:

1. **Build** — сборка Docker образа
2. **Test** — запуск тестов
3. **Deploy** — деплой на сервер

### Ручной деплой

```bash
# Сборка
docker build -t scoliologic-app .

# Запуск
docker run -d \
  --name scoliologic \
  -p 3000:3000 \
  --env-file .env \
  scoliologic-app
```

## Команды разработки

```bash
pnpm dev        # Режим разработки
pnpm build      # Сборка для продакшена
pnpm start      # Запуск продакшен сервера
pnpm check      # Проверка TypeScript
pnpm test       # Запуск тестов
pnpm db:push    # Применение миграций
pnpm db:studio  # Drizzle Studio (GUI для БД)
```

## История изменений

### v1.3.0 (2026-01-16)
- **AI-ассистент интегрирован в чаты** — AI мониторит все сообщения
- **Таймер возврата AI** — 1.5 часа после ответа врача
- **Ручное управление AI** — возможность включить/выключить
- **Маркировка сообщений AI** — визуальное отличие от врача

### v1.2.0 (2026-01-16)
- Миграция с MySQL на PostgreSQL 16
- Исправлены ошибки TypeScript

### v1.1.0 (2026-01-16)
- Интеграция с Госуслугами (ЕСИА)
- Интеграция с МИС
- Защищённый мессенджер E2EE
- AI-ассистент на базе Ollama

### v1.0.0 (2026-01-16)
- Первый релиз
- Базовый функционал приложения

## Лицензия

Проприетарное ПО. © 2024-2026 Scoliologic

## Контакты

- **Сайт**: [scoliologic.ru](https://scoliologic.ru)
- **Email**: dev@scoliologic.ru

%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#dc2626', 'primaryTextColor': '#fff', 'primaryBorderColor': '#b91c1c', 'lineColor': '#ef4444', 'secondaryColor': '#fef2f2', 'tertiaryColor': '#fff1f2'}}}%%
sequenceDiagram
    autonumber
    participant U as üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    participant A as üì± –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    participant S as ‚öôÔ∏è –°–µ—Ä–≤–µ—Ä
    participant R as üî¥ Redis
    participant E as üèõÔ∏è –ï–°–ò–ê (–ì–æ—Å—É—Å–ª—É–≥–∏)
    participant DB as üíæ PostgreSQL

    Note over U,E: üîê –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –ß–ï–†–ï–ó –ì–û–°–£–°–õ–£–ì–ò

    rect rgb(254, 242, 242)
        U->>A: –ù–∞–∂–∞—Ç–∏–µ "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –ì–æ—Å—É—Å–ª—É–≥–∏"
        A->>S: GET /api/auth/esia/login
        S->>S: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è state (UUID)
        S->>S: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è timestamp
        S->>S: RSA-SHA256 –ø–æ–¥–ø–∏—Å—å<br/>(client_id + state + timestamp)
        S->>R: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ state (TTL: 10 –º–∏–Ω)
        S-->>A: Redirect URL ‚Üí –ï–°–ò–ê
        A->>U: –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –ì–æ—Å—É—Å–ª—É–≥–∏
    end

    rect rgb(254, 249, 195)
        U->>E: –í–≤–æ–¥ –ª–æ–≥–∏–Ω–∞/–ø–∞—Ä–æ–ª—è
        E->>E: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—á—ë—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        E->>E: 2FA (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)
        E-->>U: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–æ–≥–ª–∞—Å–∏—è
        U->>E: –°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –ø–µ—Ä–µ–¥–∞—á—É –¥–∞–Ω–Ω—ã—Ö
        E-->>A: Redirect —Å code + state
    end

    rect rgb(220, 252, 231)
        A->>S: GET /api/auth/esia/callback<br/>?code=xxx&state=yyy
        S->>R: –ü—Ä–æ–≤–µ—Ä–∫–∞ state
        R-->>S: state valid ‚úì
        S->>R: –£–¥–∞–ª–µ–Ω–∏–µ state
        S->>S: RSA-SHA256 –ø–æ–¥–ø–∏—Å—å –∑–∞–ø—Ä–æ—Å–∞ —Ç–æ–∫–µ–Ω–∞
        S->>E: POST /token<br/>{code, client_id, signature}
        E-->>S: {access_token, refresh_token}
        S->>E: GET /userinfo<br/>Authorization: Bearer token
        E-->>S: {snils, firstName, lastName, ...}
    end

    rect rgb(219, 234, 254)
        S->>DB: –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –°–ù–ò–õ–°
        alt –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            DB-->>S: User found
            S->>DB: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        else –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            DB-->>S: Not found
            S->>DB: –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        end
        S->>R: –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ (TTL: 24h)
        S-->>A: Set-Cookie: session_id
        A->>U: –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ Dashboard
    end

    Note over U,E: ‚úÖ –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê

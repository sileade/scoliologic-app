%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#7c3aed', 'primaryTextColor': '#fff', 'primaryBorderColor': '#6d28d9', 'lineColor': '#8b5cf6', 'secondaryColor': '#f5f3ff', 'tertiaryColor': '#faf5ff'}}}%%
sequenceDiagram
    autonumber
    participant P as üë§ –ü–∞—Ü–∏–µ–Ω—Ç
    participant S as ‚öôÔ∏è –°–µ—Ä–≤–µ—Ä
    participant D as üë®‚Äç‚öïÔ∏è –í—Ä–∞—á
    participant AI as ü§ñ AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç

    Note over P,D: üîê –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø E2EE

    rect rgb(240, 253, 244)
        P->>P: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ECDH –∫–ª—é—á–µ–π<br/>(P-256 curve)
        P->>S: –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞
        S->>S: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
        D->>D: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ECDH –∫–ª—é—á–µ–π<br/>(P-256 curve)
        D->>S: –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞
        S->>S: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
    end

    Note over P,D: üîë –û–ë–ú–ï–ù –ö–õ–Æ–ß–ê–ú–ò

    rect rgb(254, 243, 199)
        P->>S: –ó–∞–ø—Ä–æ—Å –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞ –≤—Ä–∞—á–∞
        S-->>P: –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –≤—Ä–∞—á–∞
        P->>P: ECDH: derive shared secret
        P->>P: HKDF: derive AES-256 key
        
        D->>S: –ó–∞–ø—Ä–æ—Å –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞ –ø–∞—Ü–∏–µ–Ω—Ç–∞
        S-->>D: –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –ø–∞—Ü–∏–µ–Ω—Ç–∞
        D->>D: ECDH: derive shared secret
        D->>D: HKDF: derive AES-256 key
    end

    Note over P,D: ‚úâÔ∏è –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø

    rect rgb(219, 234, 254)
        P->>P: AES-256-GCM encrypt(message)
        P->>S: {ciphertext, iv, tag}
        S->>S: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ<br/>(plainText –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω!)
        S->>D: Push notification
        D->>S: –ó–∞–ø—Ä–æ—Å —Å–æ–æ–±—â–µ–Ω–∏—è
        S-->>D: {ciphertext, iv, tag}
        D->>D: AES-256-GCM decrypt(ciphertext)
    end

    Note over P,AI: ü§ñ AI-–ê–°–°–ò–°–¢–ï–ù–¢ (–ò–ó–û–õ–ò–†–û–í–ê–ù)

    rect rgb(252, 231, 243)
        P->>P: –û—Ç–¥–µ–ª—å–Ω—ã–π plainText –¥–ª—è AI
        P->>S: {aiContext: plainText}
        S->>AI: –ó–∞–ø—Ä–æ—Å –∫ Ollama
        AI-->>S: AI –æ—Ç–≤–µ—Ç
        S->>P: AI —Å–æ–æ–±—â–µ–Ω–∏–µ<br/>(–Ω–µ —à–∏—Ñ—Ä—É–µ—Ç—Å—è)
    end

    Note over P,D: ‚ö†Ô∏è –°–ï–†–í–ï–† –ù–ï –ò–ú–ï–ï–¢ –î–û–°–¢–£–ü–ê –ö PLAINTEXT

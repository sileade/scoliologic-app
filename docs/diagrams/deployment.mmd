%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#059669', 'primaryTextColor': '#fff', 'primaryBorderColor': '#047857', 'lineColor': '#10b981', 'secondaryColor': '#ecfdf5', 'tertiaryColor': '#f0fdf4'}}}%%
flowchart TB
    subgraph Internet["ğŸŒ Ğ˜ĞĞ¢Ğ•Ğ ĞĞ•Ğ¢"]
        USER["ğŸ‘¤ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ<br/>(Browser/Mobile)"]
        GOSUSLUGI["ğŸ›ï¸ Ğ“Ğ¾ÑÑƒÑĞ»ÑƒĞ³Ğ¸<br/>(Ğ•Ğ¡Ğ˜Ğ)"]
        MIS_EXT["ğŸ¥ ĞœĞ˜Ğ¡ ĞšĞ»Ğ¸Ğ½Ğ¸ĞºĞ¸"]
    end

    subgraph Server["ğŸ–¥ï¸ Ğ¡Ğ•Ğ Ğ’Ğ•Ğ  (Debian 13 / Ubuntu 22.04)"]
        subgraph Docker["ğŸ³ Docker Compose"]
            direction TB
            
            subgraph Frontend["Frontend Layer"]
                NGINX["ğŸ“¦ nginx:alpine<br/>:80, :443<br/>SSL Termination"]
            end
            
            subgraph Backend["Backend Layer"]
                APP["ğŸ“¦ scoliologic-app<br/>:3000<br/>Node.js 22"]
            end
            
            subgraph Data["Data Layer"]
                PG["ğŸ“¦ postgres:16<br/>:5432<br/>ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ğ‘Ğ”"]
                REDIS["ğŸ“¦ redis:7.4<br/>:6379<br/>ĞšÑÑˆ + Ğ¡ĞµÑÑĞ¸Ğ¸"]
            end
            
            subgraph AI["AI Layer"]
                OLLAMA["ğŸ“¦ ollama:latest<br/>:11434<br/>llama3.2:3b"]
            end
            
            subgraph GitOps["GitOps Layer"]
                AGENT["ğŸ“¦ pull-agent<br/>Python 3.11<br/>Auto-deploy"]
            end
        end
        
        subgraph Volumes["ğŸ’¾ Volumes"]
            VOL_PG["postgres_data"]
            VOL_REDIS["redis_data"]
            VOL_OLLAMA["ollama_models"]
            VOL_SSL["ssl_certs"]
        end
        
        subgraph Network["ğŸ”— Docker Network"]
            NET["scoliologic-network<br/>(bridge)"]
        end
    end

    subgraph GitHub["ğŸ“‚ GitHub"]
        REPO["sileade/scoliologic-app<br/>main branch"]
    end

    %% User flow
    USER -->|"HTTPS :443"| NGINX
    NGINX -->|"HTTP :3000"| APP

    %% External services
    APP -->|"OAuth 2.0"| GOSUSLUGI
    APP -->|"REST API"| MIS_EXT

    %% Internal connections
    APP -->|":5432"| PG
    APP -->|":6379"| REDIS
    APP -->|":11434"| OLLAMA

    %% GitOps
    AGENT -->|"git pull"| REPO
    AGENT -->|"docker-compose"| APP

    %% Volumes
    PG --- VOL_PG
    REDIS --- VOL_REDIS
    OLLAMA --- VOL_OLLAMA
    NGINX --- VOL_SSL

    %% Network
    NGINX --- NET
    APP --- NET
    PG --- NET
    REDIS --- NET
    OLLAMA --- NET
    AGENT --- NET

    classDef internet fill:#fef3c7,stroke:#f59e0b,stroke-width:2px
    classDef docker fill:#dbeafe,stroke:#3b82f6,stroke-width:2px
    classDef volume fill:#d1fae5,stroke:#10b981,stroke-width:2px
    classDef network fill:#fce7f3,stroke:#ec4899,stroke-width:2px
    classDef github fill:#e0e7ff,stroke:#6366f1,stroke-width:2px

    class Internet internet
    class Docker docker
    class Volumes volume
    class Network network
    class GitHub github

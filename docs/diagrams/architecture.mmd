%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#4f46e5', 'primaryTextColor': '#fff', 'primaryBorderColor': '#4338ca', 'lineColor': '#6366f1', 'secondaryColor': '#f0f9ff', 'tertiaryColor': '#f8fafc'}}}%%
flowchart TB
    subgraph Client["üñ•Ô∏è –ö–õ–ò–ï–ù–¢ (Browser/Mobile)"]
        direction TB
        UI["React 18 + TypeScript"]
        TW["TailwindCSS"]
        TRPC_C["tRPC Client"]
        RQ["React Query"]
        E2E_C["E2EE Crypto<br/>(ECDH + AES-256-GCM)"]
        IDB["IndexedDB<br/>(Offline Storage)"]
    end

    subgraph Server["‚öôÔ∏è –°–ï–†–í–ï–† (Node.js 22)"]
        direction TB
        EXPRESS["Express.js"]
        TRPC_S["tRPC Router"]
        
        subgraph Auth["üîê –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è"]
            ESIA["–ï–°–ò–ê OAuth 2.0<br/>(RSA-SHA256)"]
            SESSION["Session Manager<br/>(Redis)"]
        end
        
        subgraph Messenger["üí¨ –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä"]
            MSG_SVC["Message Service"]
            E2E_S["E2EE Key Exchange"]
            AI_SVC["AI Service<br/>(Ollama)"]
        end
        
        subgraph MIS["üè• –ú–ò–° –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è"]
            MIS_API["–ú–ò–° API Client"]
            SYNC["Sync Service"]
        end
        
        ORM["Drizzle ORM"]
    end

    subgraph Data["üíæ –•–†–ê–ù–ò–õ–ò–©–ï"]
        direction LR
        PG[("PostgreSQL 16<br/>–û—Å–Ω–æ–≤–Ω–∞—è –ë–î")]
        REDIS[("Redis 7.4<br/>–ö—ç—à + –°–µ—Å—Å–∏–∏")]
        OLLAMA["Ollama<br/>llama3.2:3b"]
    end

    subgraph External["üåê –í–ù–ï–®–ù–ò–ï –°–ï–†–í–ò–°–´"]
        direction LR
        GOSUSLUGI["–ì–æ—Å—É—Å–ª—É–≥–∏<br/>(–ï–°–ò–ê)"]
        MIS_EXT["–ú–ò–° –ö–ª–∏–Ω–∏–∫–∏"]
    end

    subgraph Deploy["üöÄ –î–ï–ü–õ–û–ô"]
        direction TB
        DOCKER["Docker Compose"]
        NGINX["Nginx<br/>(Reverse Proxy)"]
        GITOPS["GitOps Pull-Agent"]
    end

    %% Client connections
    UI --> TW
    UI --> TRPC_C
    TRPC_C --> RQ
    UI --> E2E_C
    UI --> IDB

    %% Client to Server
    TRPC_C -->|"HTTPS/WSS"| NGINX
    NGINX --> EXPRESS
    EXPRESS --> TRPC_S

    %% Server internal
    TRPC_S --> Auth
    TRPC_S --> Messenger
    TRPC_S --> MIS
    TRPC_S --> ORM

    %% Auth flow
    ESIA -->|"OAuth 2.0"| GOSUSLUGI
    SESSION --> REDIS

    %% Messenger flow
    MSG_SVC --> E2E_S
    MSG_SVC --> AI_SVC
    AI_SVC --> OLLAMA

    %% MIS flow
    MIS_API -->|"REST API"| MIS_EXT
    SYNC --> MIS_API

    %% Data connections
    ORM --> PG
    SESSION --> REDIS
    MSG_SVC --> PG

    %% Deploy
    DOCKER --> Server
    DOCKER --> Data
    GITOPS -->|"Auto-deploy"| DOCKER

    classDef client fill:#dbeafe,stroke:#3b82f6,stroke-width:2px
    classDef server fill:#fef3c7,stroke:#f59e0b,stroke-width:2px
    classDef data fill:#d1fae5,stroke:#10b981,stroke-width:2px
    classDef external fill:#fce7f3,stroke:#ec4899,stroke-width:2px
    classDef deploy fill:#e0e7ff,stroke:#6366f1,stroke-width:2px

    class Client client
    class Server server
    class Data data
    class External external
    class Deploy deploy

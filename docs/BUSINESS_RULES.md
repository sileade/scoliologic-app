# Бизнес-правила приложения колл-центра

## Обзор

Данный документ описывает реализованные бизнес-правила для приложения колл-центра клиники Сколиолоджик.

---

## 1. Правила записи на приём

### Файл: `server/booking/rules.ts`

### 1.1 Лимиты записей

| Тип приёма | Лимит в день | Примечание |
|------------|--------------|------------|
| Первичный ортопед | 8 | На одного врача |
| Повторный ортопед | 12 | На одного врача |
| ЛФК | 6 | На одного инструктора |
| Онлайн ЛФК | 8 | На одного инструктора |
| SEAS | 4 | Индивидуально |
| Психолог | 6 | На одного психолога |
| Рентген | 20 | На кабинет |

### 1.2 Правила по филиалам

| Филиал | Особенности |
|--------|-------------|
| **МСК** | Полный функционал, свой рентген |
| **СПБ** | Полный функционал, свой рентген |
| **НСК** | Без рентгена, партнёрские клиники |
| **ЕКБ** | Без рентгена, партнёрские клиники |
| **УФА** | Без рентгена, партнёрские клиники |

### 1.3 Ограничения записи

- **Минимальный интервал**: 30 минут между записями одного пациента
- **Максимум записей**: 3 активных записи на пациента
- **Первичный приём**: Только к свободному врачу (не к занятому)
- **Повторный приём**: Предпочтительно к тому же врачу

---

## 2. Интеграция с Битрикс24

### Файл: `server/bitrix/service.ts`

### 2.1 Открытые линии

Поддерживаемые каналы:
- WhatsApp
- Telegram
- ВКонтакте
- Viber
- Instagram

### 2.2 Функционал

| Функция | Описание |
|---------|----------|
| `sendMessage` | Отправка сообщения в чат |
| `createContact` | Создание контакта в CRM |
| `updateContact` | Обновление контакта |
| `createDeal` | Создание сделки |
| `handleWebhook` | Обработка входящих событий |

### 2.3 Конфигурация

```env
BITRIX_WEBHOOK_URL=https://your-domain.bitrix24.ru/rest/1/xxx/
BITRIX_OPEN_LINE_ID=1
```

---

## 3. Система предоплат

### Файл: `server/payment/prepayment.ts`

### 3.1 Услуги с предоплатой

| Услуга | Сумма | Срок действия | Возврат до |
|--------|-------|---------------|------------|
| ЛФК | 2000 ₽ | 48 часов | 24 часа |
| ЛФК онлайн | 1500 ₽ | 48 часов | 24 часа |
| Онлайн консультация | 3000 ₽ | 72 часа | 48 часов |
| SEAS | 2500 ₽ | 48 часов | 24 часа |
| Психолог | 2000 ₽ | 48 часов | 24 часа |

### 3.2 Правила предоплаты

- **ЛФК в СПБ и МСК**: Требуется предоплата
- **Онлайн консультация**: Всегда требуется предоплата
- **Возврат**: Автоматический при отмене за N часов до приёма

### 3.3 Интеграция с YooKassa

```env
YOOKASSA_SHOP_ID=your_shop_id
YOOKASSA_SECRET_KEY=your_secret_key
```

### 3.4 API эндпоинты

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/api/payment/required` | Проверка необходимости предоплаты |
| POST | `/api/payment/create` | Создание платежа |
| GET | `/api/payment/:id` | Статус платежа |
| POST | `/api/payment/:id/refund` | Возврат платежа |
| POST | `/api/payment/webhook/yookassa` | Вебхук YooKassa |

---

## 4. Лист ожидания

### Файл: `server/waitlist/service.ts`

### 4.1 Функционал

- Добавление в очередь при отсутствии слотов
- Приоритизация по времени ожидания
- Уведомление при появлении слота
- Автоматическое истечение через 30 дней

### 4.2 Параметры

| Параметр | Значение | Описание |
|----------|----------|----------|
| `notificationValidityMinutes` | 15 | Время на ответ |
| `maxNotificationsPerSlot` | 3 | Уведомлений на слот |
| `priorityBoostDays` | 7 | Повышение приоритета |
| `autoExpireDays` | 30 | Автоистечение |

### 4.3 Каналы уведомлений

- Push-уведомления
- SMS
- WhatsApp
- Telegram
- Email

### 4.4 API эндпоинты

| Метод | Путь | Описание |
|-------|------|----------|
| POST | `/api/waitlist/add` | Добавление в лист |
| GET | `/api/waitlist/:id` | Получение записи |
| POST | `/api/waitlist/:id/confirm` | Подтверждение |
| POST | `/api/waitlist/:id/decline` | Отклонение |
| DELETE | `/api/waitlist/:id` | Отмена |

---

## 5. Система контроля рентгена

### Файл: `server/xray/service.ts`

### 5.1 Направления

- Создание направления врачом
- Срок действия: 30 дней
- Обязательные поля: диагноз, клинический вопрос
- Проверка подписи и печати

### 5.2 Типы рентгена

| Код | Описание |
|-----|----------|
| `spine_full` | Полный снимок позвоночника |
| `spine_lateral` | Боковая проекция |
| `spine_ap` | Прямая проекция |
| `pelvis` | Таз |
| `other` | Другое |

### 5.3 Результаты

Сохраняемые данные:
- Угол Кобба (для сколиоза)
- Степень ротации
- Тест Риссера (0-5)
- DICOM Study ID
- Заключение рентгенолога

### 5.4 Анализ динамики

Автоматический анализ угла Кобба:
- **Улучшение**: Уменьшение > 5°
- **Стабильно**: Изменение ±5°
- **Ухудшение**: Увеличение > 5°

### 5.5 Напоминания

- Создание напоминания о контрольном рентгене
- Интервал: 6 месяцев (настраивается)
- Уведомление за 7 дней до даты

### 5.6 API эндпоинты

| Метод | Путь | Описание |
|-------|------|----------|
| POST | `/api/xray/referral` | Создание направления |
| GET | `/api/xray/referral/:id/validate` | Проверка направления |
| GET | `/api/xray/slots/:branch/:date` | Доступные слоты |
| POST | `/api/xray/book` | Запись на рентген |
| POST | `/api/xray/result` | Сохранение результата |
| GET | `/api/xray/patient/:id/cobb-analysis` | Анализ динамики |

---

## 6. Схема взаимодействия

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Пациент   │────▶│  Колл-центр │────▶│    МИС      │
└─────────────┘     └─────────────┘     └─────────────┘
       │                   │                   │
       │                   ▼                   │
       │           ┌─────────────┐             │
       │           │   Битрикс   │             │
       │           │  (Open Line)│             │
       │           └─────────────┘             │
       │                   │                   │
       ▼                   ▼                   ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  Предоплата │     │    Лист     │     │   Рентген   │
│  (YooKassa) │     │  ожидания   │     │  контроль   │
└─────────────┘     └─────────────┘     └─────────────┘
```

---

## 7. Переменные окружения

```env
# Битрикс24
BITRIX_WEBHOOK_URL=https://your-domain.bitrix24.ru/rest/1/xxx/
BITRIX_OPEN_LINE_ID=1

# YooKassa
YOOKASSA_SHOP_ID=your_shop_id
YOOKASSA_SECRET_KEY=your_secret_key

# Уведомления
SMS_PROVIDER_API_KEY=xxx
WHATSAPP_API_KEY=xxx
TELEGRAM_BOT_TOKEN=xxx
```

---

## 8. Следующие шаги

1. **Интеграция с МИС** - подключение к реальной медицинской системе
2. **Тестирование** - написание unit и integration тестов
3. **Мониторинг** - настройка логирования и алертов
4. **Документация API** - Swagger/OpenAPI спецификация
